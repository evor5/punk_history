{% extends 'base.html' %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='articles.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="page-title">üì∞ –°—Ç–∞—Ç—å–∏</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% if current_user.is_authenticated %}
    <section class="article-create-section">
        <h2>–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è</h2>
        <form method="POST" enctype="multipart/form-data" class="article-form">
            <input type="text" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏" required class="input-text">
            <textarea name="content" placeholder="–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏..." rows="6" required class="textarea expandable-textarea"></textarea>
            
            <label class="submit-button file-upload">
                –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –º–µ–¥–∏–∞
                <input type="file" name="media" class="media-input">
            </label>

            <button type="submit" class="submit-button">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </form>
    </section>
    {% endif %}

    <section class="latest-articles">
        <h3 class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
        <div class="articles-grid">
            {% for article in articles %}
            <div class="article-card">
                <a href="{{ url_for('article_details', article_id=article.id) }}" class="article-card-link-overlay" aria-label="–ß–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—å—é {{ article.title }}"></a>
                
                <div class="article-image">
                    {% if article.media_filename %}
                        <img src="{{ url_for('static', filename='uploads/' ~ article.media_filename) }}" alt="{{ article.title }}">
                    {% else %}
                        <img src="../static/uploads/default_img.png" alt="–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é">
                    {% endif %}
                </div>
                <div class="article-content">
                    <h4 class="article-title">{{ article.title }}</h4>
                    <div class="article-meta">
                        <span class="article-date">{{ article.created_at.strftime('%d.%m.%Y') }}</span>
                        <span class="article-author">–ê–≤—Ç–æ—Ä: {{ article.author.username }}</span>
                    </div>
                    <p class="article-excerpt">{{ article.content[:150] }}...</p>
                </div>

                {% if current_user.is_authenticated and current_user.id == article.author.id %}
                    <div style="text-align: right; margin-top: 8px; position: relative; z-index: 10;">
                        <form method="POST" action="{{ url_for('delete_article', article_id=article.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?');">
                            <button type="submit" class="delete-button">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </div>
                {% endif %}
            </div>
            {% endfor %}

        </div>
    </section>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const textarea = document.querySelector('.expandable-textarea');
        if (textarea) {
            textarea.addEventListener('input', function () {
                this.style.height = 'auto';
                const maxHeight = parseInt(getComputedStyle(this).maxHeight);
                const newHeight = Math.min(this.scrollHeight, maxHeight);
                this.style.height = newHeight + 'px';
            });
        }
    });
    </script>


</div>
{% endblock %}
